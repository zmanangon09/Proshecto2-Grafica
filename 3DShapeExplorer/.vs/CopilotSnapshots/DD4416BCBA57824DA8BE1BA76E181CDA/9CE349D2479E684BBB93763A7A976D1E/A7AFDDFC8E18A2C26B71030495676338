using System;
using System.Collections.Generic;
using System.Drawing;
using System.IO;
using System.Linq;
using System.Windows.Forms;
using _3D_SHAPE_EXPLORER.Forms;
using _3D_SHAPE_EXPLORER.Models;
using _3D_SHAPE_EXPLORER.Services;
using _3D_SHAPE_EXPLORER.Utils;
using Guna.UI2.WinForms;

namespace _3D_SHAPE_EXPLORER
{
    public partial class ShapeExplorerForm : Form
    {
        private SceneManager sceneManager = new SceneManager();
        private ShapeRenderer renderer = new ShapeRenderer();
        private KeyboardController inputController;
        private string lastSelected = "";
        private Color currentPaintColor = Color.Yellow;
        private MouseClickHandler mouseClickHandler;

        public ShapeExplorerForm()
        {
            InitializeComponent();
            
            // Inicializar SceneManager primero
            sceneManager.Initialize();
            
            // Inicializar controladores ANTES de configurar los ComboBox
            // para evitar NullReferenceException cuando los eventos SelectedIndexChanged se disparen
            inputController = new KeyboardController(this, picCanvas, sceneManager);
            inputController.OnStatusChanged += OnStatusChanged;
            
            // Mouse Handler now uses new controls
            mouseClickHandler = new MouseClickHandler(sceneManager, picCanvas,
                            rbtnVertex, rbtnEdge, rbtnFace, rbtnPaint, currentPaintColor);
            
            // Configurar event handlers
            SetupEventHandlers();
            
            // AHORA configurar los ComboBox (después de que inputController esté inicializado)
            SetupComboBoxFigures();
            SetupComboBoxMode();
        }

        private void SetupEventHandlers()
        {
            // Canvas
            picCanvas.Paint += PanelCanvas_Paint;
            picCanvas.MouseClick += picCanvas_MouseClick;
            picCanvas.Resize += (s, e) => picCanvas.Invalidate();

            // Siderbar Inputs
            cmbFigures.SelectedIndexChanged += CmbFigures_SelectedIndexChanged;
            cmbMode.SelectedIndexChanged += CmbMode_SelectedIndexChanged;
            
            // Buttons
            btnReset.Click += (s, e) => {
                sceneManager.Camera.Reset();
                sceneManager.Camera.SetIsometricView();
                picCanvas.Invalidate();
                inputController?.RefocusCanvas();
            };

            btnHelp.Click += (s, e) => { ShowHelp(); inputController?.RefocusCanvas(); };

            btnColor.Click += BtnSelectColor_Click;
            
            // Radios
            rbtnPaint.CheckedChanged += (s, e) => {
                btnColor.Visible = rbtnPaint.Checked;
                picCanvas.Invalidate();
            };
        }

        private void OnStatusChanged(string message)
        {
            // Optional: Update overlay temporary?
            // For now we just log or ignore as we just want static basic info
        }

        private void PanelCanvas_Paint(object sender, PaintEventArgs e)
        {
            bool isInEditMode = rbtnVertex.Checked || rbtnEdge.Checked || rbtnFace.Checked;
            renderer.Draw(e.Graphics, sceneManager.Shapes, picCanvas.Size, sceneManager, isInEditMode, currentPaintColor);
        }

        private void ShapeExplorerForm_Load(object sender, EventArgs e)
        {
            cmbMode.SelectedIndex = 0; // Object Mode by default
            btnColor.Visible = false;
            
            // Overlay Position
            lblOverlay.Parent = picCanvas;
            lblOverlay.Location = new Point(10, picCanvas.Height - 40);
            lblOverlay.Anchor = AnchorStyles.Bottom | AnchorStyles.Left;

            // Handle F6
            this.KeyPreview = true;
            this.KeyDown += ShapeExplorerForm_KeyDown;
        }

        private void ShapeExplorerForm_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.F6) ShowHelp();
        }

        private void ShowHelp()
        {
            var helpForm = new HelpForm();
            helpForm.ShowDialog(this);
        }

        private void picCanvas_MouseClick(object sender, MouseEventArgs e)
        {
            mouseClickHandler.HandleMouseClick(e.Location);
            picCanvas.Invalidate();
        }

        private void SetupComboBoxMode()
        {
            cmbMode.Items.Clear();
            cmbMode.Items.Add(new ComboBoxItem("Object Mode", "object"));
            cmbMode.Items.Add(new ComboBoxItem("Edit Mode", "edit"));
            cmbMode.SelectedIndex = 0;
        }

        private void SetupComboBoxFigures()
        {
            cmbFigures.Items.Clear();
            cmbFigures.Items.Add(new ComboBoxItem("Select Figure...", ""));
            cmbFigures.Items.Add(new ComboBoxItem("Cube", "Cube"));
            cmbFigures.Items.Add(new ComboBoxItem("Cylinder", "Cylinder"));
            cmbFigures.Items.Add(new ComboBoxItem("Cone", "Cone"));
            cmbFigures.Items.Add(new ComboBoxItem("Sphere", "Sphere"));
            cmbFigures.Items.Add(new ComboBoxItem("Pyramid", "Pyramid"));
            cmbFigures.Items.Add(new ComboBoxItem("Octahedron", "Octahedron"));
            cmbFigures.Items.Add(new ComboBoxItem("Dodecagonal", "DodecagonalPrism"));
            cmbFigures.SelectedIndex = 0;
        }

        private void CmbFigures_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (cmbFigures.SelectedItem is ComboBoxItem selectedItem)
            {
                string value = selectedItem.Value;
                if (string.IsNullOrEmpty(value)) return;

                lastSelected = value;
                var shape = ShapeFactory.Create(value);
                if (shape != null)
                {
                    sceneManager.AddShape(shape);
                    picCanvas.Invalidate();
                    inputController?.RefocusCanvas();
                }
            }
        }

        private void CmbMode_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (cmbMode.SelectedItem is ComboBoxItem selectedItem)
            {
                string modeValue = selectedItem.Value;

                if (modeValue == "edit")
                {
                    pnlEditControls.Visible = true;
                    // Default selection
                    if (!rbtnVertex.Checked && !rbtnEdge.Checked && !rbtnFace.Checked && !rbtnPaint.Checked)
                         rbtnVertex.Checked = true;
                }
                else
                {
                    pnlEditControls.Visible = false;
                    rbtnVertex.Checked = false;
                    rbtnEdge.Checked = false;
                    rbtnFace.Checked = false;
                    rbtnPaint.Checked = false;

                    sceneManager.SelectedVertexIndex = null;
                    sceneManager.SelectedEdge = null;
                    sceneManager.SelectedFace = null;
                }
                picCanvas.Invalidate();
                inputController?.RefocusCanvas();
            }
        }

        private void BtnSelectColor_Click(object sender, EventArgs e)
        {
            var colores = new List<Color> { Color.Black, Color.White, Color.Orange, Color.Gold, Color.Green, Color.Teal,
                                     Color.MidnightBlue, Color.DarkGray, Color.HotPink, Color.MediumPurple,
                                     Color.Red, Color.Blue, Color.Yellow, Color.Cyan, Color.Magenta, Color.Lime };

            var colorForm = new ColorPickerForm(colores);
            // Position near button
            var buttonLocation = btnColor.PointToScreen(Point.Empty);
            colorForm.Location = new Point(buttonLocation.X - 250, buttonLocation.Y); // Left of sidebar

            if (colorForm.ShowDialog() == DialogResult.OK)
            {
                currentPaintColor = colorForm.SelectedColor;
                btnColor.FillColor = currentPaintColor;
                btnColor.ForeColor = (currentPaintColor.R * 0.299 + currentPaintColor.G * 0.587 + currentPaintColor.B * 0.114) > 186 ? Color.Black : Color.White;
                mouseClickHandler.UpdatePaintColor(currentPaintColor);
            }
        }
    }
}
