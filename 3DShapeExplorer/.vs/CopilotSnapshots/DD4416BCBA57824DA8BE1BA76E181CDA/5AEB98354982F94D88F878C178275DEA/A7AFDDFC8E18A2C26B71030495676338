using _3D_SHAPE_EXPLORER.Forms;
using _3D_SHAPE_EXPLORER.Models;
using _3D_SHAPE_EXPLORER.Services;
using _3D_SHAPE_EXPLORER.Utils;
using Guna.UI2.WinForms;
using System;
using System.Collections.Generic;
using System.Drawing;
using System.Windows.Forms;

namespace _3D_SHAPE_EXPLORER
{
    public partial class ShapeExplorerForm : Form
    {
        // SERVICIOS Y CONTROLADORES
        private SceneManager sceneManager = new SceneManager();
        private ShapeRenderer renderer = new ShapeRenderer();
        private KeyboardController inputController;
        private MouseClickHandler mouseClickHandler;

        // --- SISTEMA DE LUZ Y ANIMACIÓN ---
        private Timer orbitTimer;
        private float lightAngle = 0;
        private bool isLightOrbiting = false;
        private float orbitRadius = 400f;
        private LightSource light = new LightSource();
        private Point3D targetLightPos = new Point3D(500, -500, -500);

        // --- UI ADICIONAL (Agregada por Código) ---
        private Guna2Button btnOrbit;
        private FlowLayoutPanel pnlColorPalette;
        private Label lblColorTitle;

        // ESTADO DEL TEMA Y COLORES
        private bool isDarkMode = true;
        private Color accentColor = Color.FromArgb(94, 148, 255);
        private Color currentPaintColor = Color.FromArgb(0, 122, 204);
        
        // Lista de colores para la paleta
        private readonly List<Color> paletteColors = new List<Color>
        {
            Color.Orange, Color.Crimson, Color.Teal, Color.Gold, 
            Color.DodgerBlue, Color.LimeGreen, Color.MediumPurple, Color.White,
            Color.Red, Color.Blue, Color.Yellow, Color.Cyan,
            Color.Magenta, Color.HotPink, Color.MidnightBlue, Color.DarkGray
        };

        public ShapeExplorerForm()
        {
            InitializeComponent();

            // 1. Inicializar Componentes de UI manuales
            InitializeCustomComponents();

            // 2. Inicializar Motores
            SetupOrbitTimer();
            ApplyTheme();

            // 3. Lógica de Negocio
            sceneManager.Initialize();
            inputController = new KeyboardController(this, picCanvas, sceneManager);
            inputController.OnF6Pressed += ShowHelp;

            mouseClickHandler = new MouseClickHandler(sceneManager, picCanvas,
                                rbtnVertex, rbtnEdge, rbtnFace, rbtnPaint, currentPaintColor);

            // 4. Configuración de Eventos
            SetupEventHandlers();
            SetupComboBoxFigures();
            SetupComboBoxMode();

            this.KeyPreview = true;
            this.Load += ShapeExplorerForm_Load;
        }

        private void InitializeCustomComponents()
        {
            // 1. Botón de órbita de luz
            btnOrbit = new Guna2Button();
            btnOrbit.Name = "btnOrbit";
            btnOrbit.Text = "💫 Orbitar Luz";
            btnOrbit.Size = new Size(140, 40);
            btnOrbit.BorderRadius = 8;
            btnOrbit.Animated = true;
            btnOrbit.FillColor = accentColor;
            btnOrbit.ForeColor = Color.White;
            btnOrbit.Font = new Font("Segoe UI Semibold", 9F);

            if (btnHelp != null && btnHelp.Parent != null)
            {
                btnHelp.Parent.Controls.Add(btnOrbit);
                btnOrbit.Location = new Point(btnHelp.Location.X, btnHelp.Location.Y + btnHelp.Height + 10);
            }
            else
            {
                this.Controls.Add(btnOrbit);
                btnOrbit.Location = new Point(20, 20);
            }
            btnOrbit.BringToFront();

            // 2. Crear el título de la paleta de colores
            lblColorTitle = new Label();
            lblColorTitle.Text = "🎨 COLORES";
            lblColorTitle.Font = new Font("Segoe UI", 9F, FontStyle.Bold);
            lblColorTitle.ForeColor = Color.Gray;
            lblColorTitle.AutoSize = true;
            lblColorTitle.Visible = false;

            // 3. Crear el panel de paleta de colores
            pnlColorPalette = new FlowLayoutPanel();
            pnlColorPalette.Name = "pnlColorPalette";
            pnlColorPalette.Size = new Size(250, 100);
            pnlColorPalette.BackColor = Color.Transparent;
            pnlColorPalette.Visible = false;
            pnlColorPalette.Padding = new Padding(0);
            pnlColorPalette.Margin = new Padding(0);

            // Crear botones de colores
            foreach (var color in paletteColors)
            {
                var colorBtn = new Guna2Button();
                colorBtn.Size = new Size(28, 28);
                colorBtn.FillColor = color;
                colorBtn.BorderRadius = 6;
                colorBtn.BorderThickness = 2;
                colorBtn.BorderColor = Color.FromArgb(60, 60, 60);
                colorBtn.Margin = new Padding(3);
                colorBtn.Tag = color;
                colorBtn.Text = "";
                
                // Evento de click para seleccionar color
                colorBtn.Click += ColorButton_Click;
                
                // Hover effects
                colorBtn.MouseEnter += (s, e) => {
                    var btn = (Guna2Button)s;
                    btn.BorderColor = Color.White;
                    btn.BorderThickness = 3;
                };
                colorBtn.MouseLeave += (s, e) => {
                    var btn = (Guna2Button)s;
                    Color btnColor = (Color)btn.Tag;
                    btn.BorderColor = btnColor == currentPaintColor ? accentColor : Color.FromArgb(60, 60, 60);
                    btn.BorderThickness = btnColor == currentPaintColor ? 3 : 2;
                };
                
                pnlColorPalette.Controls.Add(colorBtn);
            }

            // Añadir al panel de controles de edición
            if (pnlEditControls != null)
            {
                // Posicionar debajo del radio button de pintar
                lblColorTitle.Location = new Point(11, 185);
                pnlColorPalette.Location = new Point(8, 210);
                
                pnlEditControls.Controls.Add(lblColorTitle);
                pnlEditControls.Controls.Add(pnlColorPalette);
            }
        }

        private void ColorButton_Click(object sender, EventArgs e)
        {
            var btn = (Guna2Button)sender;
            currentPaintColor = (Color)btn.Tag;
            
            // Actualizar el color en el manejador de mouse
            mouseClickHandler.UpdatePaintColor(currentPaintColor);
            
            // Actualizar el botón de color principal
            btnColor.FillColor = currentPaintColor;
            btnColor.ForeColor = GetContrastColor(currentPaintColor);
            
            // Actualizar los bordes de todos los botones de la paleta
            UpdateColorPaletteSelection();
            
            picCanvas.Invalidate();
            inputController?.RefocusCanvas();
        }

        private void UpdateColorPaletteSelection()
        {
            foreach (Control ctrl in pnlColorPalette.Controls)
            {
                if (ctrl is Guna2Button colorBtn)
                {
                    Color btnColor = (Color)colorBtn.Tag;
                    if (btnColor == currentPaintColor)
                    {
                        colorBtn.BorderColor = accentColor;
                        colorBtn.BorderThickness = 3;
                    }
                    else
                    {
                        colorBtn.BorderColor = Color.FromArgb(60, 60, 60);
                        colorBtn.BorderThickness = 2;
                    }
                }
            }
        }

        private Color GetContrastColor(Color color)
        {
            // Calcular luminosidad para determinar si usar texto blanco o negro
            double luminance = (0.299 * color.R + 0.587 * color.G + 0.114 * color.B);
            return luminance > 128 ? Color.Black : Color.White;
        }

        private void SetupOrbitTimer()
        {
            orbitTimer = new Timer();
            orbitTimer.Interval = 16; // 60 FPS
            orbitTimer.Tick += (s, e) => {
                if (isLightOrbiting)
                {
                    lightAngle += 0.03f;
                    light.Position.X = (float)(Math.Cos(lightAngle) * orbitRadius);
                    light.Position.Z = (float)(Math.Sin(lightAngle) * orbitRadius);
                    light.Position.Y = (float)(Math.Sin(lightAngle * 0.5f) * 200) - 200;
                }
                picCanvas.Invalidate();
            };
        }

        #region Sistema de Temas (Dark/Light)

        private void ApplyTheme()
        {
            Color backColor = isDarkMode ? Color.FromArgb(18, 18, 20) : Color.FromArgb(242, 245, 250);
            Color canvasColor = isDarkMode ? Color.FromArgb(28, 28, 32) : Color.White;
            Color textColor = isDarkMode ? Color.White : Color.FromArgb(45, 45, 48);
            Color panelColor = isDarkMode ? Color.FromArgb(35, 35, 38) : Color.FromArgb(225, 228, 234);
            Color comboBg = isDarkMode ? Color.FromArgb(30, 30, 30) : Color.White;

            light.AmbientColor = isDarkMode ? Color.FromArgb(35, 35, 40) : Color.FromArgb(110, 110, 120);

            this.BackColor = backColor;
            picCanvas.BackColor = canvasColor;

            if (swTheme != null) swTheme.Checked = isDarkMode;

            ConfigureGunaButton(btnReset, isDarkMode ? "🔄 Reset Vista" : "🔃 Reiniciar Vista", panelColor, textColor);
            ConfigureGunaButton(btnHelp, isDarkMode ? "❓ Ayuda (F6)" : "💡 Ayuda (F6)", panelColor, textColor);
            ConfigureGunaButton(btnOrbit, "💫 Orbitar Luz", panelColor, textColor);
            ConfigureGunaButton(btnColor, "🎨 Color", currentPaintColor, Color.White);

            ConfigureGunaCombo(cmbFigures, comboBg, textColor);
            ConfigureGunaCombo(cmbMode, comboBg, textColor);

            var radios = new[] { rbtnVertex, rbtnEdge, rbtnFace, rbtnPaint };
            foreach (var rb in radios)
            {
                if (rb == null) continue;
                rb.ForeColor = textColor;
                rb.CheckedState.FillColor = accentColor;
            }

            if (lblOverlay != null)
            {
                lblOverlay.BackColor = isDarkMode ? Color.FromArgb(150, 0, 0, 0) : Color.FromArgb(150, 255, 255, 255);
                lblOverlay.ForeColor = isDarkMode ? Color.FromArgb(0, 255, 127) : Color.FromArgb(0, 102, 204);
            }

            // Actualizar estilo del título de la paleta
            if (lblColorTitle != null)
            {
                lblColorTitle.ForeColor = isDarkMode ? Color.Gray : Color.FromArgb(100, 100, 100);
            }

            picCanvas.Invalidate();
        }

        private void ConfigureGunaButton(Guna2Button btn, string text, Color bg, Color textC)
        {
            if (btn == null) return;
            btn.Text = text;
            btn.FillColor = bg;
            btn.ForeColor = textC;
            btn.Font = new Font("Segoe UI Semibold", 9F);
        }

        private void ConfigureGunaCombo(Guna2ComboBox cmb, Color bg, Color text)
        {
            if (cmb == null) return;
            cmb.FillColor = bg;
            cmb.ForeColor = text;
            cmb.BorderRadius = 8;
        }

        #endregion

        private void SetupEventHandlers()
        {
            // BOTÓN DE ÓRBITA
            btnOrbit.Click += (s, e) => {
                isLightOrbiting = !isLightOrbiting;
                if (isLightOrbiting) orbitTimer.Start();
                else orbitTimer.Stop();
                btnOrbit.FillColor = isLightOrbiting ? Color.FromArgb(255, 193, 7) : accentColor;
                btnOrbit.ForeColor = isLightOrbiting ? Color.Black : Color.White;
            };

            // DIBUJADO
            picCanvas.Paint += (s, e) => {
                bool isInEditMode = rbtnVertex.Checked || rbtnEdge.Checked || rbtnFace.Checked;
                renderer.Draw(e.Graphics, sceneManager.Shapes, picCanvas.Size, sceneManager, isInEditMode, currentPaintColor, light);
            };

            // MOUSE MOVE (LERP / SUAVE)
            picCanvas.MouseMove += (s, e) => {
                if (e.Button == MouseButtons.Right)
                {
                    isLightOrbiting = false;
                    orbitTimer.Stop();

                    targetLightPos.X = (e.X - picCanvas.Width / 2) * 2;
                    targetLightPos.Y = (e.Y - picCanvas.Height / 2) * 2;

                    light.Position.X += (targetLightPos.X - light.Position.X) * 0.15f;
                    light.Position.Y += (targetLightPos.Y - light.Position.Y) * 0.15f;

                    picCanvas.Invalidate();
                }
            };

            picCanvas.MouseClick += (s, e) => {
                if (e.Button == MouseButtons.Left)
                {
                    mouseClickHandler.HandleMouseClick(e.Location);
                    picCanvas.Invalidate();
                }
            };

            if (swTheme != null)
                swTheme.CheckedChanged += (s, e) => { isDarkMode = swTheme.Checked; ApplyTheme(); };

            btnReset.Click += (s, e) => {
                sceneManager.Camera.Reset();
                sceneManager.Camera.SetIsometricView();
                light.Position = new Point3D(500, -500, -500);
                picCanvas.Invalidate();
                inputController?.RefocusCanvas();
            };

            btnHelp.Click += (s, e) => { ShowHelp(); inputController?.RefocusCanvas(); };
            btnColor.Click += BtnSelectColor_Click;

            cmbFigures.SelectedIndexChanged += CmbFigures_SelectedIndexChanged;
            cmbMode.SelectedIndexChanged += CmbMode_SelectedIndexChanged;

            // *** Mostrar/ocultar la paleta de colores según el modo de pintura ***
            rbtnPaint.CheckedChanged += (s, e) => {
                bool showPalette = rbtnPaint.Checked;
                btnColor.Visible = showPalette;
                pnlColorPalette.Visible = showPalette;
                lblColorTitle.Visible = showPalette;
                
                if (showPalette)
                {
                    UpdateColorPaletteSelection();
                }
                picCanvas.Invalidate();
            };
            
            // Ocultar paleta cuando se selecciona otro radio button
            rbtnVertex.CheckedChanged += (s, e) => {
                if (rbtnVertex.Checked)
                {
                    btnColor.Visible = false;
                    pnlColorPalette.Visible = false;
                    lblColorTitle.Visible = false;
                }
                picCanvas.Invalidate();
            };
            
            rbtnEdge.CheckedChanged += (s, e) => {
                if (rbtnEdge.Checked)
                {
                    btnColor.Visible = false;
                    pnlColorPalette.Visible = false;
                    lblColorTitle.Visible = false;
                }
                picCanvas.Invalidate();
            };
            
            rbtnFace.CheckedChanged += (s, e) => {
                if (rbtnFace.Checked)
                {
                    btnColor.Visible = false;
                    pnlColorPalette.Visible = false;
                    lblColorTitle.Visible = false;
                }
                picCanvas.Invalidate();
            };

            SetupArrowKeysSuppression();
            this.KeyDown += ShapeExplorerForm_KeyDown;
        }

        private void ShapeExplorerForm_Load(object sender, EventArgs e)
        {
            cmbMode.SelectedIndex = 0;
            
            // Ocultar controles de edición, botón de color y paleta al inicio
            pnlEditControls.Visible = false;
            btnColor.Visible = false;
            pnlColorPalette.Visible = false;
            lblColorTitle.Visible = false;
            
            lblOverlay.Parent = picCanvas;
            lblOverlay.Location = new Point(15, picCanvas.Height - 690);
            picCanvas.Focus();
        }

        #region Lógica de Figuras y Modos

        private void SetupComboBoxMode()
        {
            cmbMode.Items.Clear();
            cmbMode.Items.Add(new ComboBoxItem("🧊 Modo Objeto", "object"));
            cmbMode.Items.Add(new ComboBoxItem("🛠️ Modo Edición", "edit"));
            cmbMode.SelectedIndex = 0;
        }

        private void SetupComboBoxFigures()
        {
            cmbFigures.Items.Clear();
            cmbFigures.Items.Add(new ComboBoxItem("➕ Añadir Figura...", ""));
            string[] figuras = { "Cube", "Cylinder", "Cone", "Sphere", "Pyramid", "Octahedron" };
            foreach (var f in figuras) cmbFigures.Items.Add(new ComboBoxItem(f, f));
            cmbFigures.SelectedIndex = 0;
        }

        private void CmbFigures_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (cmbFigures.SelectedItem is ComboBoxItem item && !string.IsNullOrEmpty(item.Value))
            {
                var shape = ShapeFactory.Create(item.Value);
                if (shape != null)
                {
                    shape.EdgeColor = isDarkMode ? Color.FromArgb(200, 200, 200) : Color.Black;
                    sceneManager.AddShape(shape);
                    picCanvas.Invalidate();
                }
                inputController?.RefocusCanvas();
                cmbFigures.SelectedIndex = 0;
            }
        }

        private void CmbMode_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (cmbMode.SelectedItem is ComboBoxItem item)
            {
                bool isEdit = item.Value == "edit";
                if (pnlEditControls != null) pnlEditControls.Visible = isEdit;
                
                // Ocultar paleta de colores al cambiar de modo
                if (!isEdit)
                {
                    sceneManager.ClearSelection();
                    pnlColorPalette.Visible = false;
                    lblColorTitle.Visible = false;
                    btnColor.Visible = false;
                }
                
                picCanvas.Invalidate();
                inputController?.RefocusCanvas();
            }
        }

        private void BtnSelectColor_Click(object sender, EventArgs e)
        {
            var colorForm = new ColorPickerForm(paletteColors);
            if (colorForm.ShowDialog() == DialogResult.OK)
            {
                currentPaintColor = colorForm.SelectedColor;
                btnColor.FillColor = currentPaintColor;
                btnColor.ForeColor = GetContrastColor(currentPaintColor);
                mouseClickHandler.UpdatePaintColor(currentPaintColor);
                UpdateColorPaletteSelection();
                picCanvas.Invalidate();
            }
        }

        #endregion

        #region Atajos y Teclas

        private void ShowHelp()
        {
            var helpForm = new HelpForm(this.isDarkMode);
            helpForm.ShowDialog(this);
        }

        private void ShapeExplorerForm_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.Control && e.KeyCode == Keys.T)
            {
                if (swTheme != null) swTheme.Checked = !swTheme.Checked;
                else { isDarkMode = !isDarkMode; ApplyTheme(); }
                e.Handled = true;
            }
            if (e.KeyCode == Keys.F6) { ShowHelp(); e.Handled = true; }
            if (e.KeyCode == Keys.O) { btnOrbit.PerformClick(); e.Handled = true; }
        }

        private void SetupArrowKeysSuppression()
        {
            var controls = new Control[] { cmbFigures, cmbMode, rbtnVertex, rbtnEdge, rbtnFace, rbtnPaint, btnReset, btnHelp, btnColor };
            foreach (var c in controls)
            {
                if (c != null) c.PreviewKeyDown += (s, e) => {
                    if (e.KeyCode >= Keys.Left && e.KeyCode <= Keys.Down) e.IsInputKey = true;
                };
            }
        }
        #endregion
    }
}