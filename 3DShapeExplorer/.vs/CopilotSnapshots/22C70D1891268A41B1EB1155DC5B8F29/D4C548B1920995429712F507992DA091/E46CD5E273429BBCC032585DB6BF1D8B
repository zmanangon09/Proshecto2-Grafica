using System;
using System.Collections.Generic;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using _3D_SHAPE_EXPLORER.Models;
using _3D_SHAPE_EXPLORER.Services;

namespace _3D_SHAPE_EXPLORER.Utils
{
    public class Projection3D
    {
        /// <summary>
        /// Proyección básica sin cámara (mantener compatibilidad)
        /// </summary>
        public static PointF Project(Point3D point, Size panelSize)
        {
            float distance = 500;
            float factor = distance / (distance + point.Z);
            float x = point.X * factor + panelSize.Width / 2;
            float y = -point.Y * factor + panelSize.Height / 2;
            return new PointF(x, y);
        }

        /// <summary>
        /// Proyección con sistema de cámara 3D orbital
        /// </summary>
        public static PointF ProjectWithCamera(Point3D point, Size panelSize, CameraController camera)
        {
            // Trasladar el punto respecto al punto focal de la cámara
            float px = point.X - camera.FocalPointX;
            float py = point.Y - camera.FocalPointY;
            float pz = point.Z - camera.FocalPointZ;

            // Aplicar rotación Yaw (horizontal - alrededor del eje Y)
            float yawRad = camera.GetYawRadians();
            float cosYaw = (float)Math.Cos(yawRad);
            float sinYaw = (float)Math.Sin(yawRad);
            
            float x1 = px * cosYaw - pz * sinYaw;
            float z1 = px * sinYaw + pz * cosYaw;
            float y1 = py;

            // Aplicar rotación Pitch (vertical - alrededor del eje X)
            float pitchRad = camera.GetPitchRadians();
            float cosPitch = (float)Math.Cos(pitchRad);
            float sinPitch = (float)Math.Sin(pitchRad);

            float y2 = y1 * cosPitch - z1 * sinPitch;
            float z2 = y1 * sinPitch + z1 * cosPitch;
            float x2 = x1;

            // Aplicar proyección perspectiva con la distancia de la cámara
            float distance = camera.Distance;
            float factor = distance / (distance + z2);
            
            float screenX = x2 * factor + panelSize.Width / 2;
            float screenY = -y2 * factor + panelSize.Height / 2;

            return new PointF(screenX, screenY);
        }

        /// <summary>
        /// Transforma un punto 3D aplicando la rotación de la cámara (sin proyectar)
        /// </summary>
        public static Point3D TransformWithCamera(Point3D point, CameraController camera)
        {
            float px = point.X - camera.FocalPointX;
            float py = point.Y - camera.FocalPointY;
            float pz = point.Z - camera.FocalPointZ;

            // Rotación Yaw
            float yawRad = camera.GetYawRadians();
            float cosYaw = (float)Math.Cos(yawRad);
            float sinYaw = (float)Math.Sin(yawRad);
            
            float x1 = px * cosYaw - pz * sinYaw;
            float z1 = px * sinYaw + pz * cosYaw;
            float y1 = py;

            // Rotación Pitch
            float pitchRad = camera.GetPitchRadians();
            float cosPitch = (float)Math.Cos(pitchRad);
            float sinPitch = (float)Math.Sin(pitchRad);

            float y2 = y1 * cosPitch - z1 * sinPitch;
            float z2 = y1 * sinPitch + z1 * cosPitch;
            float x2 = x1;

            return new Point3D(x2, y2, z2);
        }
    }
}
