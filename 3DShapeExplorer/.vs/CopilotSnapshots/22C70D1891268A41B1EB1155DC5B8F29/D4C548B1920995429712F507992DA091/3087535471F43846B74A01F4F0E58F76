using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;
using _3D_SHAPE_EXPLORER.Models;

namespace _3D_SHAPE_EXPLORER.Services
{
    public class KeyboardController
    {
        private readonly Timer timer = new Timer();
        private readonly HashSet<Keys> keys = new HashSet<Keys>();
        private readonly Control targetCanvas;
        private readonly SceneManager sceneManager;

        private const float RotationStep = 2f;
        private const float ScaleStep = 0.05f;
        private const float TranslationStep = 2f;

        // Evento para notificar cambios en el estado (para actualizar tooltips/ayuda)
        public event Action<string> OnStatusChanged;

        public KeyboardController(Form form, Control canvas, SceneManager manager)
        {
            sceneManager = manager;
            targetCanvas = canvas;

            form.KeyPreview = true;
            form.KeyDown += (s, e) => 
            {
                keys.Add(e.KeyCode);
                HandleSpecialKeys(e);
            };
            form.KeyDown += HandleDeleteKey;
            form.KeyUp += (s, e) => keys.Remove(e.KeyCode);

            timer.Interval = 20;
            timer.Tick += (s, e) => UpdateTransformations();
            timer.Start();
        }

        private void HandleSpecialKeys(KeyEventArgs e)
        {
            // Vistas predefinidas de cámara (con tecla F)
            switch (e.KeyCode)
            {
                case Keys.F1:
                    sceneManager.Camera.SetFrontView();
                    OnStatusChanged?.Invoke("Vista: Frontal");
                    targetCanvas.Invalidate();
                    break;
                case Keys.F2:
                    sceneManager.Camera.SetTopView();
                    OnStatusChanged?.Invoke("Vista: Superior");
                    targetCanvas.Invalidate();
                    break;
                case Keys.F3:
                    sceneManager.Camera.SetRightView();
                    OnStatusChanged?.Invoke("Vista: Lateral Derecha");
                    targetCanvas.Invalidate();
                    break;
                case Keys.F4:
                    sceneManager.Camera.SetLeftView();
                    OnStatusChanged?.Invoke("Vista: Lateral Izquierda");
                    targetCanvas.Invalidate();
                    break;
                case Keys.F5:
                    sceneManager.Camera.SetIsometricView();
                    OnStatusChanged?.Invoke("Vista: Isométrica");
                    targetCanvas.Invalidate();
                    break;
                case Keys.Home:
                    sceneManager.Camera.Reset();
                    OnStatusChanged?.Invoke("Cámara reiniciada");
                    targetCanvas.Invalidate();
                    break;
            }
        }

        private void UpdateTransformations()
        {
            bool needsRedraw = false;

            // ===== CONTROLES DE CÁMARA (Flechas y +/-) =====
            if (keys.Contains(Keys.Left))
            {
                sceneManager.Camera.RotateLeft();
                needsRedraw = true;
            }
            if (keys.Contains(Keys.Right))
            {
                sceneManager.Camera.RotateRight();
                needsRedraw = true;
            }
            if (keys.Contains(Keys.Up))
            {
                sceneManager.Camera.RotateUp();
                needsRedraw = true;
            }
            if (keys.Contains(Keys.Down))
            {
                sceneManager.Camera.RotateDown();
                needsRedraw = true;
            }
            if (keys.Contains(Keys.Add) || keys.Contains(Keys.Oemplus))
            {
                sceneManager.Camera.ZoomIn();
                needsRedraw = true;
            }
            if (keys.Contains(Keys.Subtract) || keys.Contains(Keys.OemMinus))
            {
                sceneManager.Camera.ZoomOut();
                needsRedraw = true;
            }

            // ===== CONTROLES DE FIGURA SELECCIONADA =====
            Shape3D selectedShape = sceneManager.Shapes.Find(s => s.IsSelected);
            if (selectedShape != null)
            {
                bool somethingTransformed = false;

                // Transformar vértice seleccionado
                if (sceneManager.SelectedVertexIndex.HasValue)
                {
                    int index = sceneManager.SelectedVertexIndex.Value;
                    ApplyTransformationToPoint(selectedShape.OriginalPoints[index]);
                    somethingTransformed = true;
                }
                // Transformar arista seleccionada
                else if (sceneManager.SelectedEdge != null)
                {
                    var (i1, i2) = sceneManager.SelectedEdge;
                    ApplyTransformationToPoint(selectedShape.OriginalPoints[i1]);
                    ApplyTransformationToPoint(selectedShape.OriginalPoints[i2]);
                    somethingTransformed = true;
                }
                // Transformar cara seleccionada
                else if (sceneManager.SelectedFace != null)
                {
                    foreach (var index in sceneManager.SelectedFace)
                    {
                        ApplyTransformationToPoint(selectedShape.OriginalPoints[index]);
                    }
                    somethingTransformed = true;
                }

                // Transformar figura completa
                if (!somethingTransformed)
                {
                    // Rotación de la figura (NumPad y A/D)
                    if (keys.Contains(Keys.NumPad4)) { selectedShape.RotationX -= RotationStep; needsRedraw = true; }
                    if (keys.Contains(Keys.NumPad6)) { selectedShape.RotationX += RotationStep; needsRedraw = true; }
                    if (keys.Contains(Keys.NumPad8)) { selectedShape.RotationY -= RotationStep; needsRedraw = true; }
                    if (keys.Contains(Keys.NumPad2)) { selectedShape.RotationY += RotationStep; needsRedraw = true; }
                    if (keys.Contains(Keys.A)) { selectedShape.RotationZ -= RotationStep; needsRedraw = true; }
                    if (keys.Contains(Keys.D)) { selectedShape.RotationZ += RotationStep; needsRedraw = true; }

                    // Escala de la figura (W/S)
                    if (keys.Contains(Keys.W)) { selectedShape.ScaleFactor += ScaleStep; needsRedraw = true; }
                    if (keys.Contains(Keys.S)) { selectedShape.ScaleFactor = Math.Max(0.1f, selectedShape.ScaleFactor - ScaleStep); needsRedraw = true; }

                    // Traslación de la figura (J/L, I/K, U/O)
                    if (keys.Contains(Keys.J)) { selectedShape.TraslateX -= TranslationStep; needsRedraw = true; }
                    if (keys.Contains(Keys.L)) { selectedShape.TraslateX += TranslationStep; needsRedraw = true; }
                    if (keys.Contains(Keys.I)) { selectedShape.TraslateY += TranslationStep; needsRedraw = true; }
                    if (keys.Contains(Keys.K)) { selectedShape.TraslateY -= TranslationStep; needsRedraw = true; }
                    if (keys.Contains(Keys.U)) { selectedShape.TraslateZ -= TranslationStep; needsRedraw = true; }
                    if (keys.Contains(Keys.O)) { selectedShape.TraslateZ += TranslationStep; needsRedraw = true; }
                }
                else
                {
                    needsRedraw = true;
                }
            }

            if (needsRedraw)
            {
                targetCanvas.Invalidate();
            }
        }

        private void ApplyTransformationToPoint(Point3D point)
        {
            if (keys.Contains(Keys.J)) point.X -= TranslationStep;
            if (keys.Contains(Keys.L)) point.X += TranslationStep;
            if (keys.Contains(Keys.I)) point.Y += TranslationStep;
            if (keys.Contains(Keys.K)) point.Y -= TranslationStep;
            if (keys.Contains(Keys.U)) point.Z -= TranslationStep;
            if (keys.Contains(Keys.O)) point.Z += TranslationStep;

            if (keys.Contains(Keys.W))
            {
                point.X *= 1 + ScaleStep;
                point.Y *= 1 + ScaleStep;
                point.Z *= 1 + ScaleStep;
            }
            if (keys.Contains(Keys.S))
            {
                point.X *= 1 - ScaleStep;
                point.Y *= 1 - ScaleStep;
                point.Z *= 1 - ScaleStep;
            }
        }

        private void HandleDeleteKey(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Back || e.KeyCode == Keys.Delete)
            {
                Shape3D selectedShape = sceneManager.Shapes.Find(s => s.IsSelected);
                if (selectedShape != null)
                {
                    var result = MessageBox.Show(
                        "¿Desea eliminar la figura seleccionada?",
                        "Confirmar eliminación",
                        MessageBoxButtons.YesNo,
                        MessageBoxIcon.Warning
                    );

                    if (result == DialogResult.Yes)
                    {
                        sceneManager.Shapes.Remove(selectedShape);
                        sceneManager.SelectedVertexIndex = null;
                        sceneManager.SelectedEdge = null;
                        sceneManager.SelectedFace = null;
                        sceneManager.SelectedShapeIndex = null;
                        OnStatusChanged?.Invoke("Figura eliminada");
                        targetCanvas.Invalidate();
                    }
                }
            }
        }

        /// <summary>
        /// Obtiene una descripción de todos los controles disponibles
        /// </summary>
        public static string GetControlsHelp()
        {
            return @"═══════════════════════════════════════════
   🎮 CONTROLES DE TECLADO
═══════════════════════════════════════════

📷 CÁMARA (observar la escena):
   ← → ↑ ↓    Rotar cámara
   + / -      Zoom In / Out
   F1         Vista Frontal
   F2         Vista Superior
   F3         Vista Lateral Derecha
   F4         Vista Lateral Izquierda
   F5         Vista Isométrica
   Home       Reiniciar cámara

🔄 ROTACIÓN (figura seleccionada):
   NumPad 4/6   Rotar en X
   NumPad 8/2   Rotar en Y
   A / D        Rotar en Z

📏 ESCALA (figura seleccionada):
   W            Aumentar tamaño
   S            Reducir tamaño

↔️ TRASLACIÓN (figura seleccionada):
   J / L        Mover en X
   I / K        Mover en Y
   U / O        Mover en Z

🗑️ ELIMINAR:
   Delete/Backspace  Eliminar figura

═══════════════════════════════════════════";
        }
    }
}
